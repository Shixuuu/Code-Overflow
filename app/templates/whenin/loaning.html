<!DOCTYPE html>
<link rel="stylesheet" href="{{url_for('static',filename='css/index.css')}}">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">
<style>

</style>
<html>
    {% include 'navbar.html'%}
    <div class="frame"><img src="{{ url_for('static', filename='img/jarbg.png') }}"  class="backgroundbig"></div>

    {% include 'profileButton.html'%}
    <div id='bg' style="display:flex;flex-direction: row;">
        <div style="width:50%;display:flex;justify-content: center;">
            <div id="poly" style="padding: 35%; margin: 10%; background: #ffa800;display:flex;justify-content: center;">
                <div id="add loans here" style="display:flex;flex-direction: column;align-items: flex-start;position:absolute;z-index: 99;margin-top:-11%;width: 30%">
                    <div style="text-align: center;font-size: 200%;margin-left:auto;margin-right:auto;margin-bottom: 15px;">
                        Loans
                    </div>
                    <div id="no ongoing loans" style="margin-left:auto;margin-right:auto;font-size:150%;display:none;margin-top:15px">
                        No ongoing loans
                    </div>
                </div>
            </div>
        </div>
        <div style="width: 50%;display:flex;justify-content: center;flex-direction: column;">
            <div style="padding: 7px;;background: #e2e2e2; margin-left: 10%;margin-right:10%;margin-top:10%;padding-top: 20px">
                <div style="font-size: 150%;text-align: center;background-color: #ffcc59;padding:15px;margin-left:15px;margin-right:15px">
                    Friend List
                </div>
            </div>
            <div style="padding:35%;margin: 10%;margin-top:0; background: #e2e2e2;display:flex;justify-content: center;">
                <div id="friends" style="display:flex;flex-direction: column; align-items:flex-start;position: absolute;width:35%;margin-top: -17%;overflow:auto;height:65%">
                    <div id="no friends" style="margin-left:auto;margin-right:auto;font-size:120%;display:none;margin-top:15px">
                        No friends
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Loan Amount Modal -->
    <div id="loanModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <form id="loanForm">
                <label for="loanAmount">Enter Loan Amount:</label>
                <input type="number" id="loanAmount" name="loanAmount" required>
                <input type="hidden" id="friendId" name="friendId">
                <button type="submit">Submit</button>
            </form>
        </div>
    </div>
    <!-- Modal Styles -->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
    
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
    
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
    
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    var loanModal = document.getElementById('loanModal');
    var loanForm = document.getElementById('loanForm');

    // Function to inject friends into the DOM
    function renderFriends(friendlist) {
        var friendsContainer = document.getElementById("friends");
        var noFriendsMessage = document.getElementById("no friends"); // Get the 'no friends' element

        // Check if the 'friends' container and 'no friends' message exist
        if (!friendsContainer) {
            console.error("Friends container not found in the DOM.");
            return;
        }

        if (!noFriendsMessage) {
            console.error("'No friends' message not found in the DOM.");
        }

        // Clear previous content
        friendsContainer.innerHTML = '';

        // Check if there are no friends
        if (friendlist.length == 0 && noFriendsMessage) {
            noFriendsMessage.style.display = 'block'; // Show 'no friends' message
        } else if (noFriendsMessage) {
            noFriendsMessage.style.display = 'none'; // Hide 'no friends' message
            for (var i = 0; i < friendlist.length; i++) {
                var friendHtml = `
                <div style='display:flex;flex-direction: row;justify-content: space-between'>
                    <div style="display:flex;flex-direction: row;align-items: center;">
                        <img src="${friendlist[i].image}" id="img" alt="${friendlist[i].name}">
                        <span id="tablename">${friendlist[i].name}</span>
                    </div>
                    <div style="padding:15px;background-color: #ffa800;border-radius: 7px;">
                        $${friendlist[i].money}
                    </div>
                    <a href="#" class="loan-link" data-friend-id="${friendlist[i].id}">Loan</a>
                </div>`;

                // Append friendHtml to the friends container
                friendsContainer.innerHTML += friendHtml;
            }

            // After friends are added to the DOM, add event listeners to the loan links
            document.querySelectorAll('.loan-link').forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const friendId = this.getAttribute('data-friend-id');
                    console.log(`Setting friendId to ${friendId}`);
                    document.getElementById('friendId').value = friendId;
                    loanModal.style.display = 'block';
                });
            });
        }
    }

    // Close the loan modal when clicking on the close button
    loanModal.querySelector('.close').addEventListener('click', function() {
        loanModal.style.display = 'none';
    });

    // Close the loan modal when clicking outside the modal
    window.addEventListener('click', function(event) {
        if (event.target == loanModal) {
            loanModal.style.display = 'none';
        }
    });

    document.getElementById('loanForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var loanAmount = document.getElementById('loanAmount').value;
    var friendId = document.getElementById('friendId').value;
    console.log(`Submitting loan with friendId: ${friendId} and loanAmount: ${loanAmount}`);
    
    fetch('/loan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            friend_id: friendId,
            loan_amount: loanAmount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Loan successful!');
            location.reload();
        } else {
            alert('Loan failed: ' + data.message);
        }
    });
});
    // Render the friend list by passing in the friendlist data
    renderFriends({{ friends|tojson }});
});

    </script>
</html>